<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
        :root {
            --background: #301935;
            --text: #e5e6fa;
            --text-prediction: rgba(229, 230, 250, 0.5);
            --btn-background: #e5e6fa;
            --text-btn: #301935;

            --radius-btn: 52px;
            --radius-container: 16px;

            --spacing-gap: 12px;
            --spacing-padding: 24px;

            --font-size-text: 18px;
            --font-size-btn: 14px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text);
            background: var(--background);
            padding: var(--spacing-padding);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-gap);
            min-height: 100%;
            border-radius: var(--radius-container);
        }

        .content-area {
            flex: 1;
            min-height: 80px;
            overflow-y: auto;
        }

        .text-content {
            font-size: var(--font-size-text);
            font-weight: 400;
            line-height: 1.4;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .text-placeholder {
            color: var(--text-prediction);
        }

        .text-generated {
            color: var(--text);
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-prediction);
            font-size: var(--font-size-text);
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-prediction);
            border-top-color: var(--text);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .button-row {
            display: flex;
            gap: var(--spacing-gap);
            align-items: center;
            flex-shrink: 0;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 36px;
            border: none;
            border-radius: var(--radius-btn);
            font-family: inherit;
            font-size: var(--font-size-btn);
            font-weight: 400;
            cursor: pointer;
            transition: opacity 0.15s ease;
            white-space: nowrap;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--btn-background);
            color: var(--text-btn);
            padding: 12px 16px;
        }

        .btn-secondary {
            background: var(--btn-background);
            color: var(--text-btn);
            padding: 12px 16px;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text);
            padding: 12px 6px;
        }

        .btn-icon {
            background: transparent;
            width: 36px;
            height: 36px;
            padding: 6px;
        }

        .btn-icon svg {
            width: 24px;
            height: 24px;
        }

        .btn-icon svg path {
            fill: var(--text);
        }

        /* Resize handle */
        .resize-handle {
            position: fixed;
            bottom: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            cursor: nwse-resize;
            opacity: 0.5;
        }

        .resize-handle svg {
            width: 100%;
            height: 100%;
            stroke: var(--text);
        }

        .resize-handle:hover {
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="content-area" id="contentArea">
        <div class="text-content text-placeholder" id="placeholder">Mindcomplete...</div>
        <div class="text-content text-generated" id="continuation" style="display: none;"></div>
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Generating...</span>
        </div>
    </div>

    <!-- Initial state: Generate button -->
    <div class="button-row" id="mainButtons">
        <button class="btn btn-primary" id="continueBtn">Generate</button>
    </div>

    <!-- After generation: Add to canvas, Clear, Regenerate -->
    <div class="button-row" id="acceptButtons" style="display: none;">
        <button class="btn btn-secondary" id="acceptBtn">Add to canvas</button>
        <button class="btn btn-ghost" id="cancelBtn">Clear</button>
        <button class="btn btn-icon" id="regenerateBtn" title="Regenerate">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 4V1L8 5L12 9V6C15.31 6 18 8.69 18 12C18 13.01 17.75 13.97 17.3 14.8L18.76 16.26C19.54 15.03 20 13.57 20 12C20 7.58 16.42 4 12 4ZM12 18C8.69 18 6 15.31 6 12C6 10.99 6.25 10.03 6.7 9.2L5.24 7.74C4.46 8.97 4 10.43 4 12C4 16.42 7.58 20 12 20V23L16 19L12 15V18Z"
                    fill="currentColor" />
            </svg>
        </button>
    </div>

    <div class="resize-handle" id="resizeHandle">
        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2L2 14" stroke-width="1.5" stroke-linecap="round" />
            <path d="M14 8L8 14" stroke-width="1.5" stroke-linecap="round" />
            <path d="M14 14L14 14" stroke-width="1.5" stroke-linecap="round" />
        </svg>
    </div>

    <script>
        var currentNodeId = null;
        var currentText = '';
        var sectionContext = '';
        var suggestion = '';
        var isLoading = false;

        var API_URL = 'https://purplevalley.co/api/predict';

        var placeholder = document.getElementById('placeholder');
        var continuation = document.getElementById('continuation');
        var loading = document.getElementById('loading');
        var mainButtons = document.getElementById('mainButtons');
        var acceptButtons = document.getElementById('acceptButtons');
        var continueBtn = document.getElementById('continueBtn');
        var acceptBtn = document.getElementById('acceptBtn');
        var cancelBtn = document.getElementById('cancelBtn');
        var regenerateBtn = document.getElementById('regenerateBtn');

        // Resize functionality
        var resizeHandle = document.getElementById('resizeHandle');
        var isResizing = false;

        resizeHandle.addEventListener('mousedown', function (e) {
            isResizing = true;
            e.preventDefault();
        });

        document.addEventListener('mousemove', function (e) {
            if (!isResizing) return;
            var width = Math.max(200, e.clientX + 10);
            var height = Math.max(150, e.clientY + 10);
            parent.postMessage({ pluginMessage: { type: 'resize', width: width, height: height } }, '*');
        });

        document.addEventListener('mouseup', function () {
            isResizing = false;
        });

        window.onmessage = function (event) {
            var msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'quick-generate') {
                quickGenerate(msg.text, msg.nodeId);
                return;
            }

            if (msg.type === 'selection-result' || msg.type === 'selection-changed') {
                if (msg.text) {
                    currentNodeId = msg.nodeId;
                    currentText = msg.text;
                    sectionContext = msg.sectionContext || '';
                } else {
                    currentNodeId = null;
                    currentText = '';
                    sectionContext = '';
                }
            }

            if (msg.type === 'accept-result' && msg.success) {
                resetUI();
            }
        };

        function quickGenerate(text, nodeId) {
            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            })
                .then(function (response) {
                    if (!response.ok) throw new Error('API error');
                    return response.body.getReader();
                })
                .then(function (reader) {
                    var decoder = new TextDecoder();
                    var result = '';

                    function read() {
                        return reader.read().then(function (data) {
                            if (data.done) {
                                parent.postMessage({
                                    pluginMessage: { type: 'quick-result', success: true, suggestion: result, nodeId: nodeId }
                                }, '*');
                                return;
                            }

                            var chunk = decoder.decode(data.value, { stream: true });
                            var lines = chunk.split('\n');

                            for (var i = 0; i < lines.length; i++) {
                                var line = lines[i];
                                if (line.indexOf('data: ') === 0) {
                                    var jsonStr = line.slice(6);
                                    if (jsonStr === '[DONE]') continue;
                                    try {
                                        var parsed = JSON.parse(jsonStr);
                                        var content = parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.content;
                                        if (content) result += content;
                                    } catch (e) { }
                                }
                            }
                            return read();
                        });
                    }
                    return read();
                })
                .catch(function (err) {
                    parent.postMessage({ pluginMessage: { type: 'quick-result', success: false } }, '*');
                });
        }

        function resetUI() {
            suggestion = '';
            placeholder.style.display = 'block';
            continuation.style.display = 'none';
            continuation.textContent = '';
            mainButtons.style.display = 'flex';
            acceptButtons.style.display = 'none';
        }

        function generateContinuation() {
            if (!currentText) {
                placeholder.textContent = 'Select a text layer first...';
                return;
            }
            if (isLoading) return;

            isLoading = true;
            suggestion = '';
            placeholder.style.display = 'none';
            continuation.style.display = 'none';
            loading.style.display = 'flex';

            var textToSend = currentText;
            if (sectionContext) {
                textToSend = '[Context from section]\n' + sectionContext + '\n\n[Continue this text]\n' + currentText;
            }

            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: textToSend })
            })
                .then(function (response) {
                    if (!response.ok) throw new Error('API error');
                    return response.body.getReader();
                })
                .then(function (reader) {
                    var decoder = new TextDecoder();
                    loading.style.display = 'none';
                    continuation.style.display = 'block';

                    function read() {
                        return reader.read().then(function (data) {
                            if (data.done) {
                                if (suggestion) {
                                    mainButtons.style.display = 'none';
                                    acceptButtons.style.display = 'flex';
                                } else {
                                    placeholder.textContent = 'No suggestion generated...';
                                    placeholder.style.display = 'block';
                                }
                                isLoading = false;
                                return;
                            }

                            var chunk = decoder.decode(data.value, { stream: true });
                            var lines = chunk.split('\n');

                            for (var i = 0; i < lines.length; i++) {
                                var line = lines[i];
                                if (line.indexOf('data: ') === 0) {
                                    var jsonStr = line.slice(6);
                                    if (jsonStr === '[DONE]') continue;
                                    try {
                                        var parsed = JSON.parse(jsonStr);
                                        var content = parsed.choices && parsed.choices[0] && parsed.choices[0].delta && parsed.choices[0].delta.content;
                                        if (content) {
                                            suggestion += content;
                                            continuation.textContent = suggestion;
                                        }
                                    } catch (e) { }
                                }
                            }
                            return read();
                        });
                    }
                    return read();
                })
                .catch(function (err) {
                    placeholder.textContent = 'Failed to generate...';
                    placeholder.style.display = 'block';
                    loading.style.display = 'none';
                    isLoading = false;
                });
        }

        function acceptSuggestion() {
            if (!currentNodeId || !suggestion) return;
            parent.postMessage({
                pluginMessage: {
                    type: 'accept-suggestion',
                    nodeId: currentNodeId,
                    newText: currentText + ' ' + suggestion
                }
            }, '*');
            currentText = currentText + ' ' + suggestion;
            resetUI();
        }

        continueBtn.addEventListener('click', generateContinuation);
        regenerateBtn.addEventListener('click', generateContinuation);
        acceptBtn.addEventListener('click', acceptSuggestion);
        cancelBtn.addEventListener('click', resetUI);

        parent.postMessage({ pluginMessage: { type: 'get-selected-text' } }, '*');
    </script>
</body>

</html>